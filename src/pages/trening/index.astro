---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Card from "../../components/Card.astro";
import Button from "../../components/Button.astro";
import Section from "../../components/Section.astro";

const title = "Trening";
const description =
    "Artikler om hvordan du kan trene smartere p√• landeveien ‚Äì med fokus p√• mosjonister som vil bli sterkere uten √• leve som proffer.";

// Hent alle markdown-artikler i denne mappa
const rawArticles = await Astro.glob("./*.md");

const WORDS_PER_MINUTE = 220;

// Prioritet (lavt tall = vis f√∏rst)
const getPriority = (url: string) => {
    switch (url) {
        case "/trening/4-watt-per-kg":
            return 1;
        case "/trening/sweet-spot-progresjon":
            return 2;
        default:
            return 99;
    }
};

// Vanskelighetsgrad for sortering
const difficultyOrder = (difficulty?: string) => {
    switch ((difficulty ?? "").toLowerCase()) {
        case "nybegynner":
            return 1;
        case "viderekommen":
            return 2;
        case "avansert":
            return 3;
        default:
            return 2;
    }
};

// Velg et lite ikon basert p√• f√∏rste tag
const iconForTags = (tags: string[] = []) => {
    const first = (tags[0] ?? "").toLowerCase();
    if (first.includes("ftp")) return "üìä";
    if (first.includes("sweet")) return "‚ö°";
    if (first.includes("vo2")) return "ü´Å";
    if (first.includes("z2")) return "üßä";
    if (first.includes("base")) return "üèóÔ∏è";
    if (first.includes("klatr")) return "‚õ∞Ô∏è";
    return "üö¥‚Äç‚ôÇÔ∏è";
};

// Bygg artikkel-meta
const articles = await Promise.all(
    rawArticles.map(async (mod) => {
        const frontmatter: any = mod.frontmatter ?? {};
        const html = (await mod.compiledContent?.()) ?? "";
        const text = html.replace(/<[^>]+>/g, " ");
        const words = text.split(/\s+/).filter(Boolean).length;
        const readingMinutes = words
            ? Math.max(1, Math.round(words / WORDS_PER_MINUTE))
            : undefined;

        const tags: string[] = frontmatter.tags ?? [];
        const difficulty: string | undefined = frontmatter.difficulty;
        const updated: string | undefined = frontmatter.updated;

        let updatedLabel: string | undefined = undefined;
        if (updated) {
            const d = new Date(updated);
            if (!Number.isNaN(d.getTime())) {
                updatedLabel = d.toLocaleDateString("nb-NO", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                });
            }
        }

        const icon = iconForTags(tags);

        return {
            url: mod.url,
            title: frontmatter.title ?? "Uten tittel",
            description:
                frontmatter.description ?? "Les artikkelen",
            tags,
            difficulty,
            updated,
            updatedLabel,
            readingMinutes,
            icon,
            priority: getPriority(mod.url),
        };
    })
);

// Sorter artikler
articles.sort((a, b) => {
    if (a.priority !== b.priority) return a.priority - b.priority;
    const da = difficultyOrder(a.difficulty);
    const db = difficultyOrder(b.difficulty);
    if (da !== db) return da - db;
    return a.title.localeCompare(b.title, "nb");
});
---

<BaseLayout {title} {description}>
    <header class="mb-8">
        <h1 class="text-3xl font-semibold tracking-tight text-slate-50 sm:text-4xl">
            Trening for landeveis-mosjonister
        </h1>
        <p class="mt-3 max-w-2xl text-sm text-slate-300">
            Enkle, √¶rlige artikler om hvordan du kan bli sterkere p√• sykkel ‚Äì med smart belastning
            og trenings√∏kter som faktisk lar seg gjennomf√∏re i en vanlig uke.
        </p>
    </header>

    {articles.length > 0 ? (
            <Section title="Artikler">
                <div class="grid gap-4 md:grid-cols-2">
                    {articles.map((article) => (
                            <Card title={`${article.icon} ${article.title}`}>
                                <p class="mt-1 text-xs text-slate-300">
                                    {article.description}
                                </p>

                                {article.tags.length > 0 && (
                                        <div class="mt-3 flex flex-wrap gap-1.5">
                                            {article.tags.map((tag) => (
                                                    <span
                                                            class="inline-flex items-center rounded-full border border-slate-700 bg-slate-900/70 px-2 py-0.5 text-[0.65rem] uppercase tracking-[0.16em] text-slate-300"
                                                    >
                    {tag}
                  </span>
                                            ))}
                                        </div>
                                )}

                                {(article.readingMinutes || article.updatedLabel) && (
                                        <div class="mt-3 flex flex-wrap items-center gap-x-3 gap-y-1 text-[0.7rem] text-slate-400">
                                            {article.readingMinutes && (
                                                    <span>Lesetid: {article.readingMinutes} min</span>
                                            )}
                                            {article.updatedLabel && (
                                                    <span>Oppdatert: {article.updatedLabel}</span>
                                            )}
                                            {article.difficulty && (
                                                    <span>
                    Niv√•: {article.difficulty.charAt(0).toUpperCase() +
                                                        article.difficulty.slice(1)}
                  </span>
                                            )}
                                        </div>
                                )}

                                <div class="mt-4">
                                    <Button href={article.url} variant="ghost">
                                        Les artikkelen
                                    </Button>
                                </div>
                            </Card>
                    ))}
                </div>
            </Section>
    ) : (
            <p class="text-sm text-slate-300">
                Ingen artikler publisert enda. Kommer snart.
            </p>
    )}
</BaseLayout>