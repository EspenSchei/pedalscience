---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Button from "../../components/Button.astro";
import Card from "../../components/Card.astro";

const title = "FTP Calculator";
const description =
    "Calculate your cycling training zones based on FTP using the Coggan power zones model, plus W/kg analysis.";
---

<BaseLayout {title} {description}>
    <header class="mb-6">
        <h1 class="text-2xl font-semibold tracking-tight text-slate-900 sm:text-3xl">
            FTP Calculator
        </h1>
        <p class="mt-2 max-w-2xl text-sm text-slate-600">
            Functional Threshold Power (FTP) represents the highest power you can sustain for approximately one hour.
            This calculator generates personalized training zones based on Dr. Andrew Coggan's widely-used 7-zone model,
            helping you train at the right intensity for your goals.
        </p>
        <p class="mt-2 max-w-2xl text-xs text-slate-500">
            FTP testing is typically done via a 20-minute all-out effort (multiply average power by 0.95) or a dedicated
            ramp test. Regular testing every 4–8 weeks helps track fitness progression.
        </p>
    </header>

    <div class="mt-4 grid gap-6 md:grid-cols-2">
        <div class="space-y-4">
            <!-- Test Type -->
            <div class="space-y-1 text-sm">
                <label for="testType">How did you test your FTP?</label>
                <select id="testType" class="w-full">
                    <option value="direct">I know my FTP (direct input)</option>
                    <option value="20min">20-minute test (will apply 0.95 factor)</option>
                    <option value="8min">8-minute test (will apply 0.90 factor)</option>
                    <option value="ramp">Ramp test (will apply 0.75 factor)</option>
                </select>
            </div>

            <!-- Power Input -->
            <div class="space-y-1 text-sm">
                <label for="powerInput" id="powerLabel">FTP (watts)</label>
                <input
                        id="powerInput"
                        type="number"
                        min="80"
                        max="600"
                        step="1"
                        value="250"
                        class="w-full"
                />
                <p id="powerHelp" class="form-help">
                    Enter your known FTP or test result.
                </p>
            </div>

            <!-- Weight Input -->
            <div class="space-y-1 text-sm">
                <label for="weightInput">Body weight (kg) – optional</label>
                <input
                        id="weightInput"
                        type="number"
                        min="40"
                        max="150"
                        step="0.1"
                        value=""
                        placeholder="e.g. 75"
                        class="w-full"
                />
                <p class="form-help">
                    Used to calculate W/kg – a key metric for climbing performance.
                </p>
            </div>

            <!-- Zone Model -->
            <div class="space-y-1 text-sm">
                <label for="zoneModel">Zone model</label>
                <select id="zoneModel" class="w-full">
                    <option value="coggan" selected>Coggan 7-zone (classic)</option>
                    <option value="polarized">Polarized 3-zone</option>
                    <option value="sweetspot">Sweet Spot focused</option>
                </select>
                <p class="form-help">
                    Different models suit different training philosophies.
                </p>
            </div>

            <div class="form-actions">
                <Button id="calcBtn" type="button" variant="primary">
                    Calculate zones
                </Button>
            </div>
        </div>

        <div class="space-y-4">
            <Card title="Summary">
                <div id="summaryText" class="text-sm text-slate-600">
                    Enter your power data and click "Calculate zones".
                </div>
            </Card>

            <Card title="W/kg Reference">
                <div class="text-xs text-slate-600 space-y-1">
                    <p class="flex justify-between"><span>Recreational cyclist:</span> <span class="font-medium">2.0–2.5 W/kg</span></p>
                    <p class="flex justify-between"><span>Club cyclist:</span> <span class="font-medium">2.5–3.2 W/kg</span></p>
                    <p class="flex justify-between"><span>Strong amateur:</span> <span class="font-medium">3.2–4.0 W/kg</span></p>
                    <p class="flex justify-between"><span>Cat 1/Elite amateur:</span> <span class="font-medium">4.0–5.0 W/kg</span></p>
                    <p class="flex justify-between"><span>Professional:</span> <span class="font-medium">5.5–6.5+ W/kg</span></p>
                </div>
            </Card>
        </div>
    </div>

    <Card class="mt-6" title="Training Zones">
        <div
                id="zonesGrid"
                class="mt-3 grid gap-2 text-xs text-slate-700 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
        >
            <!-- filled by JavaScript -->
        </div>
    </Card>

    <Card class="mt-6" title="Understanding Training Zones">
        <div class="text-xs text-slate-600 space-y-3">
            <div class="grid gap-3 sm:grid-cols-2">
                <div>
                    <p class="font-semibold text-slate-800">Zone 1 – Recovery</p>
                    <p>Very easy spinning. Used for warm-ups, cool-downs, and recovery rides. Promotes blood flow without adding training stress.</p>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Zone 2 – Endurance</p>
                    <p>The foundation of aerobic fitness. Conversational pace. Building volume here improves fat oxidation and aerobic base.</p>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Zone 3 – Tempo</p>
                    <p>"No man's land" for some coaches, useful for others. Moderate effort that builds muscular endurance without high stress.</p>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Zone 4 – Threshold</p>
                    <p>Sustainable hard effort around FTP. Key zone for time trialists and building lactate tolerance. 20–60 min intervals.</p>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Zone 5 – VO₂max</p>
                    <p>Hard intervals that stress your aerobic system maximally. 3–8 minute efforts. Builds peak aerobic power.</p>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Zone 6 – Anaerobic</p>
                    <p>Very hard, short efforts (30s–2min). Develops anaerobic capacity for attacks, short climbs, and sprint leadouts.</p>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Zone 7 – Neuromuscular</p>
                    <p>All-out sprints under 30 seconds. Maximum power development. Full recovery between efforts is essential.</p>
                </div>
                <div>
                    <p class="font-semibold text-slate-800">Sweet Spot (88–94%)</p>
                    <p>Just below threshold. High training stimulus with manageable fatigue. Popular for time-crunched athletes.</p>
                </div>
            </div>
            <p class="text-slate-500 pt-2 border-t border-slate-100">
                <strong>Reference:</strong> Coggan, A. & Allen, H. (2010). Training and Racing with a Power Meter.
                | Seiler, S. (2010). What is best practice for training intensity and duration distribution in endurance athletes?
            </p>
        </div>
    </Card>

    <script type="module">
        const testType = document.getElementById("testType");
        const powerInput = document.getElementById("powerInput");
        const powerLabel = document.getElementById("powerLabel");
        const powerHelp = document.getElementById("powerHelp");
        const weightInput = document.getElementById("weightInput");
        const zoneModel = document.getElementById("zoneModel");
        const calcBtn = document.getElementById("calcBtn");
        const zonesGrid = document.getElementById("zonesGrid");
        const summaryText = document.getElementById("summaryText");

        // Update labels based on test type
        testType.addEventListener("change", () => {
            const type = testType.value;
            if (type === "direct") {
                powerLabel.textContent = "FTP (watts)";
                powerHelp.textContent = "Enter your known FTP value.";
            } else if (type === "20min") {
                powerLabel.textContent = "20-minute average power (watts)";
                powerHelp.textContent = "Your average power from a 20-minute all-out test. We'll multiply by 0.95.";
            } else if (type === "8min") {
                powerLabel.textContent = "8-minute average power (watts)";
                powerHelp.textContent = "Your average power from an 8-minute all-out test. We'll multiply by 0.90.";
            } else if (type === "ramp") {
                powerLabel.textContent = "Ramp test max 1-min power (watts)";
                powerHelp.textContent = "The highest 1-minute power from your ramp test. We'll multiply by 0.75.";
            }
        });

        function getFTP() {
            const power = Number(powerInput.value);
            const type = testType.value;

            if (type === "20min") return power * 0.95;
            if (type === "8min") return power * 0.90;
            if (type === "ramp") return power * 0.75;
            return power;
        }

        function formatRange(min, max) {
            if (min === null) return `≤ ${Math.round(max)} W`;
            if (max === null) return `≥ ${Math.round(min)} W`;
            return `${Math.round(min)}–${Math.round(max)} W`;
        }

        function getCogganZones(ftp) {
            return [
                { name: "Zone 1 – Recovery", pct: [0, 55], color: "bg-slate-100" },
                { name: "Zone 2 – Endurance", pct: [56, 75], color: "bg-blue-100" },
                { name: "Zone 3 – Tempo", pct: [76, 90], color: "bg-green-100" },
                { name: "Zone 4 – Threshold", pct: [91, 105], color: "bg-yellow-100" },
                { name: "Zone 5 – VO₂max", pct: [106, 120], color: "bg-orange-100" },
                { name: "Zone 6 – Anaerobic", pct: [121, 150], color: "bg-red-100" },
                { name: "Zone 7 – Neuromuscular", pct: [151, null], color: "bg-purple-100" },
            ].map(z => ({
                ...z,
                range: [z.pct[0] ? (z.pct[0] / 100) * ftp : null, z.pct[1] ? (z.pct[1] / 100) * ftp : null]
            }));
        }

        function getPolarizedZones(ftp) {
            return [
                { name: "Zone 1 – Easy (below VT1)", pct: [0, 80], color: "bg-green-100", description: "~80% of training time" },
                { name: "Zone 2 – Moderate (VT1–VT2)", pct: [81, 100], color: "bg-yellow-100", description: "Minimize time here" },
                { name: "Zone 3 – Hard (above VT2)", pct: [101, null], color: "bg-red-100", description: "~20% of training time" },
            ].map(z => ({
                ...z,
                range: [z.pct[0] ? (z.pct[0] / 100) * ftp : null, z.pct[1] ? (z.pct[1] / 100) * ftp : null]
            }));
        }

        function getSweetSpotZones(ftp) {
            return [
                { name: "Recovery", pct: [0, 55], color: "bg-slate-100" },
                { name: "Endurance (Z2)", pct: [56, 75], color: "bg-blue-100" },
                { name: "Tempo", pct: [76, 87], color: "bg-green-100" },
                { name: "Sweet Spot ⭐", pct: [88, 94], color: "bg-amber-200 border-amber-400", highlight: true },
                { name: "Threshold", pct: [95, 105], color: "bg-yellow-100" },
                { name: "VO₂max+", pct: [106, null], color: "bg-red-100" },
            ].map(z => ({
                ...z,
                range: [z.pct[0] ? (z.pct[0] / 100) * ftp : null, z.pct[1] ? (z.pct[1] / 100) * ftp : null]
            }));
        }

        function renderZones(ftp, model) {
            let zones;
            if (model === "polarized") zones = getPolarizedZones(ftp);
            else if (model === "sweetspot") zones = getSweetSpotZones(ftp);
            else zones = getCogganZones(ftp);

            zonesGrid.innerHTML = "";

            zones.forEach((zone) => {
                const div = document.createElement("div");
                div.className = `rounded-xl border border-slate-200 px-3 py-2 shadow-sm ${zone.color || "bg-white"} ${zone.highlight ? "ring-2 ring-amber-400" : ""}`;

                const [min, max] = zone.range;
                const pctText = min === null && max != null
                    ? `0–${zone.pct[1]}%`
                    : max === null && min != null
                        ? `≥${zone.pct[0]}%`
                        : `${zone.pct[0]}–${zone.pct[1]}%`;

                div.innerHTML = `
                    <div class="font-semibold text-slate-900">${zone.name}</div>
                    <div class="text-slate-800">${formatRange(min, max)}</div>
                    <div class="text-[0.7rem] text-slate-500">${pctText} of FTP</div>
                    ${zone.description ? `<div class="text-[0.65rem] text-slate-400 mt-1">${zone.description}</div>` : ""}
                `;
                zonesGrid.appendChild(div);
            });
        }

        function handleCalc() {
            const power = Number(powerInput.value);
            const type = testType.value;
            const model = zoneModel.value;
            const weightVal = weightInput.value.trim();
            const weight = weightVal === "" ? null : Number(weightVal);

            if (!power || power <= 0) {
                summaryText.innerHTML = `<p class="text-amber-600">Enter a valid power value.</p>`;
                zonesGrid.innerHTML = "";
                return;
            }

            const ftp = getFTP();

            let testInfo = "";
            if (type === "20min") testInfo = ` (${power} W × 0.95)`;
            else if (type === "8min") testInfo = ` (${power} W × 0.90)`;
            else if (type === "ramp") testInfo = ` (${power} W × 0.75)`;

            let summary = `<p class="font-semibold text-slate-800">Estimated FTP: <span class="text-lg">${Math.round(ftp)} W</span>${testInfo}</p>`;

            if (weight && weight > 0) {
                const wkg = ftp / weight;
                let level = "";
                if (wkg < 2.0) level = "Building fitness";
                else if (wkg < 2.5) level = "Recreational";
                else if (wkg < 3.2) level = "Club level";
                else if (wkg < 4.0) level = "Strong amateur";
                else if (wkg < 5.0) level = "Cat 1/Elite amateur";
                else level = "Pro level";

                summary += `
                    <p class="mt-2">
                        <span class="font-medium">${wkg.toFixed(2)} W/kg</span> 
                        <span class="text-slate-500">at ${weight} kg</span>
                    </p>
                    <p class="text-xs text-slate-500 mt-1">${level}</p>
                `;
            }

            summaryText.innerHTML = summary;
            renderZones(ftp, model);
        }

        calcBtn.addEventListener("click", handleCalc);

        // Auto-calculate on change
        [testType, powerInput, weightInput, zoneModel].forEach(el => {
            el.addEventListener("change", handleCalc);
        });

        handleCalc();
    </script>
</BaseLayout>
