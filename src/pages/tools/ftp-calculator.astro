---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Button from "../../components/Button.astro";
import Card from "../../components/Card.astro";

const title = "FTP Calculator";
const description =
    "Calculate training zones in watts and percentage of FTP, as well as W/kg, in seconds.";
---

<BaseLayout {title} {description}>
    <header class="mb-6">
        <h1 class="text-2xl font-semibold tracking-tight text-slate-900 sm:text-3xl">
            FTP Calculator
        </h1>
        <p class="mt-2 max-w-2xl text-sm text-slate-600">
            Enter your FTP in watts (or the result from a 20-minute test), and get suggested
            training zones based on the classic Coggan model. You can also enter weight to see W/kg.
        </p>
    </header>

    <div class="mt-4 grid gap-6 md:grid-cols-2">
        <div class="space-y-4">
            <div class="space-y-1 text-sm">
                <label for="ftpInput">FTP (watts)</label>
                <input
                        id="ftpInput"
                        type="number"
                        min="80"
                        max="600"
                        step="1"
                        value="250"
                        class="w-full"
                />
                <p class="form-help">
                    If you only have a 20-minute test: take average watts × 0.95 and enter here.
                </p>
            </div>

            <div class="space-y-1 text-sm">
                <label for="weightInput">Weight (kg) – optional</label>
                <input
                        id="weightInput"
                        type="number"
                        min="40"
                        max="150"
                        step="0.1"
                        value="75"
                        class="w-full"
                />
                <p class="form-help">
                    Only used to calculate W/kg. Leave empty to skip.
                </p>
            </div>

            <div class="form-actions">
                <Button id="calcBtn" type="button" variant="primary">
                    Calculate zones
                </Button>
            </div>
        </div>

        <Card as="div" id="summaryBox" class="h-fit" title="Summary">
            <p id="summaryText" class="mt-1 text-xs text-slate-600">
                Enter FTP (and optionally weight), and click "Calculate zones".
            </p>
        </Card>
    </div>

    <Card as="div" id="zonesBox" class="mt-6" title="Training Zones (based on FTP)">
        <div
                id="zonesGrid"
                class="mt-3 grid gap-2 text-xs text-slate-700 sm:grid-cols-2 lg:grid-cols-3"
        >
            <!-- filled by JavaScript -->
        </div>
    </Card>

    <script type="module">
        const ftpInput = document.getElementById("ftpInput");
        const weightInput = document.getElementById("weightInput");
        const calcBtn = document.getElementById("calcBtn");
        const zonesGrid = document.getElementById("zonesGrid");
        const summaryText = document.getElementById("summaryText");

        function formatRange(min, max) {
            if (min === null) return `≤ ${Math.round(max)} W`;
            if (max === null) return `≥ ${Math.round(min)} W`;
            return `${Math.round(min)}–${Math.round(max)} W`;
        }

        function calcZones(ftp) {
            const pct = {
                z1: [0, 0.55],
                z2: [0.56, 0.75],
                z3: [0.76, 0.9],
                z4: [0.91, 1.05],
                z5: [1.06, 1.2],
                z6: [1.21, 1.5],
                z7: [1.51, 2.0],
            };

            return {
                z1: { name: "Zone 1 – Recovery", range: [null, pct.z1[1] * ftp] },
                z2: {
                    name: "Zone 2 – Endurance",
                    range: [pct.z2[0] * ftp, pct.z2[1] * ftp],
                },
                z3: { name: "Zone 3 – Tempo", range: [pct.z3[0] * ftp, pct.z3[1] * ftp] },
                z4: { name: "Zone 4 – Threshold", range: [pct.z4[0] * ftp, pct.z4[1] * ftp] },
                z5: { name: "Zone 5 – VO₂max", range: [pct.z5[0] * ftp, pct.z5[1] * ftp] },
                z6: { name: "Zone 6 – Anaerobic", range: [pct.z6[0] * ftp, pct.z6[1] * ftp] },
                z7: {
                    name: "Zone 7 – Sprint/Neuromuscular",
                    range: [pct.z7[0] * ftp, null],
                },
            };
        }

        function renderZones(ftp) {
            const zones = calcZones(ftp);
            zonesGrid.innerHTML = "";

            Object.values(zones).forEach((zone) => {
                const div = document.createElement("div");
                div.className =
                    "rounded-xl border border-slate-200 bg-white px-3 py-2 shadow-sm";

                const [min, max] = zone.range;

                const pctText =
                    min === null && max != null
                        ? `0–${Math.round((max / ftp) * 100)} %`
                        : max === null && min != null
                            ? `≥ ${Math.round((min / ftp) * 100)} %`
                            : `${Math.round((min / ftp) * 100)}–${Math.round(
                                (max / ftp) * 100,
                            )} %`;

                div.innerHTML = `
          <div class="font-semibold text-slate-900">${zone.name}</div>
          <div class="text-slate-800">${formatRange(min, max)}</div>
          <div class="text-[0.7rem] text-slate-500">${pctText} of FTP</div>
        `;
                zonesGrid.appendChild(div);
            });
        }

        function handleCalc() {
            const ftp = Number(ftpInput.value);
            const weightVal = weightInput.value.trim();
            const weight = weightVal === "" ? null : Number(weightVal);

            if (!ftp || ftp <= 0) {
                summaryText.textContent = "Enter a valid FTP value in watts.";
                zonesGrid.innerHTML = "";
                return;
            }

            let summary = `FTP: ${ftp} W`;
            if (weight && weight > 0) {
                const wkg = ftp / weight;
                summary += ` (${wkg.toFixed(2)} W/kg at ${weight.toFixed(1)} kg)`;
            }

            summaryText.textContent = summary;
            renderZones(ftp);
        }

        calcBtn.addEventListener("click", handleCalc);
        handleCalc();
    </script>
</BaseLayout>
