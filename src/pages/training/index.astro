---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Card from "../../components/Card.astro";
import Button from "../../components/Button.astro";
import Section from "../../components/Section.astro";

const title = "Training";
const description =
    "Articles on how to train smarter on the road â€“ focused on recreational cyclists who want to get stronger without living like pros.";

// Get all markdown articles in this folder
const rawArticles = await Astro.glob("./*.md");

const WORDS_PER_MINUTE = 220;

// Priority (low number = show first)
const getPriority = (url: string) => {
    switch (url) {
        case "/training/4-watt-per-kg":
            return 1;
        case "/training/sweet-spot-progression":
            return 2;
        default:
            return 99;
    }
};

// Difficulty order for sorting
const difficultyOrder = (difficulty?: string) => {
    switch ((difficulty ?? "").toLowerCase()) {
        case "beginner":
            return 1;
        case "intermediate":
            return 2;
        case "advanced":
            return 3;
        default:
            return 2;
    }
};

// Choose a small icon based on first tag
const iconForTags = (tags: string[] = []) => {
    const first = (tags[0] ?? "").toLowerCase();
    if (first.includes("ftp")) return "ðŸ“Š";
    if (first.includes("sweet")) return "âš¡";
    if (first.includes("vo2")) return "ðŸ«";
    if (first.includes("z2")) return "ðŸ§Š";
    if (first.includes("base")) return "ðŸ—ï¸";
    if (first.includes("climb")) return "â›°ï¸";
    return "ðŸš´â€â™‚ï¸";
};

// Build article meta
const articles = await Promise.all(
    rawArticles.map(async (mod) => {
        const frontmatter: any = mod.frontmatter ?? {};
        const html = (await mod.compiledContent?.()) ?? "";
        const text = html.replace(/<[^>]+>/g, " ");
        const words = text.split(/\s+/).filter(Boolean).length;
        const readingMinutes = words
            ? Math.max(1, Math.round(words / WORDS_PER_MINUTE))
            : undefined;

        const tags: string[] = frontmatter.tags ?? [];
        const difficulty: string | undefined = frontmatter.difficulty;
        const updated: string | undefined = frontmatter.updated;

        let updatedLabel: string | undefined = undefined;
        if (updated) {
            const d = new Date(updated);
            if (!Number.isNaN(d.getTime())) {
                updatedLabel = d.toLocaleDateString("en-US", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                });
            }
        }

        const icon = iconForTags(tags);

        return {
            url: mod.url,
            title: frontmatter.title ?? "Untitled",
            description:
                frontmatter.description ?? "Read the article",
            tags,
            difficulty,
            updated,
            updatedLabel,
            readingMinutes,
            icon,
            priority: getPriority(mod.url),
        };
    })
);

// Sort articles
articles.sort((a, b) => {
    if (a.priority !== b.priority) return a.priority - b.priority;
    const da = difficultyOrder(a.difficulty);
    const db = difficultyOrder(b.difficulty);
    if (da !== db) return da - db;
    return a.title.localeCompare(b.title, "en");
});
---

<BaseLayout {title} {description}>
    <header class="mb-8">
        <h1 class="text-3xl font-semibold tracking-tight text-slate-900 sm:text-4xl">
            Training for Recreational Road Cyclists
        </h1>
        <p class="mt-3 max-w-2xl text-sm text-slate-600">
            Simple, honest articles about how you can get stronger on the bike â€“ with smart loading
            and training sessions that can actually fit into a normal week.
        </p>
    </header>

    {articles.length > 0 ? (
            <Section title="Articles">
                <div class="grid gap-4 md:grid-cols-2">
                    {articles.map((article) => (
                            <Card title={`${article.icon} ${article.title}`}>
                                <p class="mt-1 text-xs text-slate-600">
                                    {article.description}
                                </p>

                                {article.tags.length > 0 && (
                                        <div class="mt-3 flex flex-wrap gap-1.5">
                                            {article.tags.map((tag) => (
                                                    <span
                                                            class="inline-flex items-center rounded-full border border-slate-200 bg-slate-100 px-2 py-0.5 text-[0.65rem] uppercase tracking-[0.16em] text-slate-700"
                                                    >
                    {tag}
                  </span>
                                            ))}
                                        </div>
                                )}

                                {(article.readingMinutes || article.updatedLabel) && (
                                        <div class="mt-3 flex flex-wrap items-center gap-x-3 gap-y-1 text-[0.7rem] text-slate-500">
                                            {article.readingMinutes && (
                                                    <span>Reading time: {article.readingMinutes} min</span>
                                            )}
                                            {article.updatedLabel && (
                                                    <span>Updated: {article.updatedLabel}</span>
                                            )}
                                            {article.difficulty && (
                                                    <span>
                    Level:{" "}
                                                        {article.difficulty.charAt(0).toUpperCase() +
                                                            article.difficulty.slice(1)}
                  </span>
                                            )}
                                        </div>
                                )}

                                <div class="mt-4">
                                    <Button href={article.url} variant="ghost">
                                        Read article
                                    </Button>
                                </div>
                            </Card>
                    ))}
                </div>
            </Section>
    ) : (
            <p class="text-sm text-slate-600">
                No articles published yet. Coming soon.
            </p>
    )}
</BaseLayout>